name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-portable:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»ºä¾¿æºç‰ˆ
      run: .\scripts\build-for-ci.bat
      
    - name: æ£€æŸ¥æ„å»ºç»“æœ
      run: |
        if (Test-Path "dist\portable") {
          Write-Host "âœ… ä¾¿æºç‰ˆç›®å½•å·²åˆ›å»º"
          Get-ChildItem "dist\portable" | ForEach-Object { Write-Host "  - $($_.Name)" }
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          if (Test-Path "dist\portable\app\node.exe") {
            $nodeSize = (Get-Item "dist\portable\app\node.exe").Length / 1MB
            Write-Host "âœ… Node.js å¯æ‰§è¡Œæ–‡ä»¶: $([math]::Round($nodeSize, 2)) MB"
          } else {
            Write-Host "âŒ Node.js å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          }
          
          if (Test-Path "dist\portable\app\server\index.js") {
            Write-Host "âœ… æœåŠ¡å™¨æ–‡ä»¶å­˜åœ¨"
          } else {
            Write-Host "âŒ æœåŠ¡å™¨æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          }
          
          if (Test-Path "dist\portable\start-tool.bat") {
            Write-Host "âœ… å¯åŠ¨è„šæœ¬å­˜åœ¨"
          } else {
            Write-Host "âŒ å¯åŠ¨è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          }
        } else {
          Write-Host "âŒ ä¾¿æºç‰ˆç›®å½•ä¸å­˜åœ¨"
          exit 1
        }
        
    - name: æ‰“åŒ…ä¾¿æºç‰ˆ
      run: |
        Compress-Archive -Path "dist\portable\*" -DestinationPath "LLMæ‰¹å¤„ç†å·¥å…·-å…å®‰è£…ç‰ˆ-${{ github.ref_name }}.zip" -Force
        if (Test-Path "LLMæ‰¹å¤„ç†å·¥å…·-å…å®‰è£…ç‰ˆ-${{ github.ref_name }}.zip") {
          $size = (Get-Item "LLMæ‰¹å¤„ç†å·¥å…·-å…å®‰è£…ç‰ˆ-${{ github.ref_name }}.zip").Length / 1MB
          Write-Host "âœ… æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ æ‰“åŒ…å¤±è´¥"
          exit 1
        }
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: portable-build
        path: LLMæ‰¹å¤„ç†å·¥å…·-å…å®‰è£…ç‰ˆ-*.zip

  create-release:
    needs: build-portable
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: portable-build
        path: ./artifacts
        
    - name: ç§»åŠ¨æ–‡ä»¶åˆ°æ ¹ç›®å½•
      run: |
        mv ./artifacts/LLMæ‰¹å¤„ç†å·¥å…·-å…å®‰è£…ç‰ˆ-*.zip ./
        ls -la LLMæ‰¹å¤„ç†å·¥å…·-å…å®‰è£…ç‰ˆ-*.zip
        
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: |
          LLMæ‰¹å¤„ç†å·¥å…·-å…å®‰è£…ç‰ˆ-*.zip
        body: |
          ## ğŸš€ LLMæ‰¹å¤„ç†å·¥å…· ${{ github.ref_name }}
          
          ä¸€ä¸ªç®€å•æ˜“ç”¨çš„AIæ‰¹é‡å¤„ç†å·¥å…·ï¼Œè®©æ‚¨è½»æ¾å¤„ç†å¤§é‡æ•°æ®ï¼
          
          ### ğŸ“¦ å¿«é€Ÿå¼€å§‹
          
          1. ä¸‹è½½ `LLMæ‰¹å¤„ç†å·¥å…·-å…å®‰è£…ç‰ˆ-${{ github.ref_name }}.zip`
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. åŒå‡» `start-tool.bat` å³å¯ä½¿ç”¨
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ğŸ“Š **æ‰¹é‡å¤„ç†æ–‡ä»¶** - æ”¯æŒCSVã€Excelã€JSONæ ¼å¼
          - ğŸ¤– **å¤šç§AIæ¨¡å‹** - å…¼å®¹OpenAIã€DeepSeekã€é˜¿é‡Œäº‘ç™¾ç‚¼ç­‰
          - âš¡ **å®æ—¶è¿›åº¦** - å¯è§†åŒ–è¿›åº¦æ¡ï¼Œéšæ—¶æŸ¥çœ‹å¤„ç†çŠ¶æ€  
          - ğŸ”„ **æ–­ç‚¹ç»­ä¼ ** - æ„å¤–ä¸­æ–­åå¯ç»§ç»­å¤„ç†
          - ğŸ¨ **ç®€æ´ç•Œé¢** - ç°ä»£åŒ–è®¾è®¡ï¼Œæ“ä½œç®€å•ç›´è§‚
          - ğŸ“± **å…å®‰è£…** - ç»¿è‰²ä¾¿æºï¼Œä¸‹è½½å³ç”¨
          
          ### ğŸ’¡ ä½¿ç”¨åœºæ™¯
          
          - æ‰¹é‡ç¿»è¯‘æ–‡æœ¬å†…å®¹
          - æ•°æ®åˆ†æå’Œæ€»ç»“
          - å†…å®¹å®¡æ ¸å’Œåˆ†ç±»
          - æ–‡æœ¬æ ¼å¼è½¬æ¢
          - å…¶ä»–AIæ‰¹å¤„ç†ä»»åŠ¡
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - Windows 10 æˆ–æ›´æ–°ç‰ˆæœ¬
          - çº¦ 1GB å¯ç”¨ç©ºé—´
          
          ### ğŸ“– æ›´å¤šå¸®åŠ©
          
          - [ä½¿ç”¨æ•™ç¨‹](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [å¸¸è§é—®é¢˜](https://github.com/${{ github.repository }}/issues)
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # å¦‚æœæƒé™ä¸è¶³ï¼Œå¯ä»¥ä½¿ç”¨Personal Access Token
        # GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
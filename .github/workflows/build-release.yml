name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  build-portable:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: å®‰è£…ä¾èµ–
      run: npm ci
      
    - name: æ„å»ºå‰ç«¯
      run: npm run build
      
    - name: æ„å»ºä¾¿æºç‰ˆ
      run: .\scripts\build-for-ci.bat
      
    - name: æ£€æŸ¥æ„å»ºç»“æœ
      run: |
        if (Test-Path "dist\portable") {
          Write-Host "âœ… ä¾¿æºç‰ˆç›®å½•å·²åˆ›å»º"
          Get-ChildItem "dist\portable" | ForEach-Object { Write-Host "  - $($_.Name)" }
        } else {
          Write-Host "âŒ ä¾¿æºç‰ˆç›®å½•ä¸å­˜åœ¨"
          exit 1
        }
        
    - name: æ‰“åŒ…ä¾¿æºç‰ˆ
      run: |
        Compress-Archive -Path "dist\portable\*" -DestinationPath "LLMæ‰¹å¤„ç†å·¥å…·-ä¾¿æºç‰ˆ-${{ github.ref_name }}.zip" -Force
        if (Test-Path "LLMæ‰¹å¤„ç†å·¥å…·-ä¾¿æºç‰ˆ-${{ github.ref_name }}.zip") {
          $size = (Get-Item "LLMæ‰¹å¤„ç†å·¥å…·-ä¾¿æºç‰ˆ-${{ github.ref_name }}.zip").Length / 1MB
          Write-Host "âœ… æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "âŒ æ‰“åŒ…å¤±è´¥"
          exit 1
        }
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: portable-build
        path: LLMæ‰¹å¤„ç†å·¥å…·-ä¾¿æºç‰ˆ-*.zip

  create-release:
    needs: build-portable
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: portable-build
        
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v1
      with:
        files: |
          LLMæ‰¹å¤„ç†å·¥å…·-ä¾¿æºç‰ˆ-*.zip
        body: |
          ## ğŸš€ LLMæ‰¹å¤„ç†å·¥å…· ${{ github.ref_name }}
          
          ## âš ï¸ é‡è¦æé†’
          
          **ğŸ”’ éå•†ä¸šè®¸å¯è¯ï¼šæœ¬è½¯ä»¶ä»…é™ä¸ªäººå­¦ä¹ ç ”ç©¶ä½¿ç”¨ï¼Œç¦æ­¢å•†ä¸šç”¨é€”**
          
          **ğŸ’° APIè´¹ç”¨è‡ªè´Ÿï¼šä½¿ç”¨ç¬¬ä¸‰æ–¹LLMæœåŠ¡äº§ç”Ÿçš„è´¹ç”¨ç”±ç”¨æˆ·æ‰¿æ‹…**
          
          **ğŸ›¡ï¸ ä½¿ç”¨é£é™©è‡ªæ‹…ï¼šè¯·ä»”ç»†é˜…è¯»LICENSEå’ŒTERMS_OF_USE.md**
          
          ### ğŸ“¦ ä¾¿æºç‰ˆä¸‹è½½
          
          ä¸‹è½½ `LLMæ‰¹å¤„ç†å·¥å…·-ä¾¿æºç‰ˆ-${{ github.ref_name }}.zip`ï¼Œè§£å‹åï¼š
          1. é˜…è¯»LICENSEå’ŒTERMS_OF_USE.mdæ–‡ä»¶
          2. åŒå‡» `å¯åŠ¨å·¥å…·.bat` å³å¯ä½¿ç”¨
          
          ### âœ¨ ä¸»è¦åŠŸèƒ½
          
          - âœ… æ”¯æŒCSVã€Excelã€JSONæ–‡ä»¶æ‰¹é‡å¤„ç†
          - âœ… å…¼å®¹OpenAIã€DeepSeekã€é˜¿é‡Œäº‘ç™¾ç‚¼ç­‰å¤šç§LLM API
          - âœ… å®æ—¶WebSocketè¿›åº¦æ¨é€å’ŒçŠ¶æ€ç›‘æ§
          - âœ… æ–­ç‚¹ç»­ä¼ åŠŸèƒ½ï¼Œæ”¯æŒä»»åŠ¡ä¸­æ–­æ¢å¤
          - âœ… ç°ä»£åŒ–Reactå‰ç«¯ç•Œé¢
          - âœ… ä¾¿æºç‰ˆä¸€é”®å¯åŠ¨ï¼Œæ— éœ€å¤æ‚é…ç½®
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - Windows 10+
          - Node.js 16+ å·²å®‰è£…
          - ç«¯å£ 3001 å¯ç”¨
          
          ### ğŸš¨ ä½¿ç”¨é™åˆ¶
          
          - **ä¸ªäººä½¿ç”¨**ï¼šä»…é™ä¸ªäººå­¦ä¹ ã€ç ”ç©¶å’Œéå•†ä¸šç”¨é€”
          - **å•†ä¸šç¦æ­¢**ï¼šç¦æ­¢é”€å”®ã€å‡ºç§Ÿæˆ–é›†æˆåˆ°ä»˜è´¹äº§å“
          - **ä¼ä¸šä½¿ç”¨**ï¼šéœ€è¦å•ç‹¬çš„å•†ä¸šè®¸å¯è¯
          - **è´£ä»»è‡ªè´Ÿ**ï¼šAPIè´¹ç”¨ã€æ•°æ®å®‰å…¨å’Œä½¿ç”¨é£é™©ç”±ç”¨æˆ·æ‰¿æ‹…
          
          ### ğŸ“– æ–‡æ¡£é“¾æ¥
          
          - [ä½¿ç”¨è¯´æ˜](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [éƒ¨ç½²æŒ‡å—](https://github.com/${{ github.repository }}/blob/main/DEPLOYMENT.md)
          - [è®¸å¯è¯](https://github.com/${{ github.repository }}/blob/main/LICENSE)
          - [ä½¿ç”¨æ¡æ¬¾](https://github.com/${{ github.repository }}/blob/main/TERMS_OF_USE.md)
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # å¦‚æœæƒé™ä¸è¶³ï¼Œå¯ä»¥ä½¿ç”¨Personal Access Token
        # GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}